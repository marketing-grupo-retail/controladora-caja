! PROGRAMA PARA IMPRIMIR TIQUES, PARTIENDO DEL ROLLO DE AUDITORIA
! TULIO ANGEL GIRALDO
!---------------------------------------------------------------------------

STRING MES$,DIA$,NTER$,NTER1$,NTRAN$,FECHA$,FECHA1$,FECHA2$,TIQUE$,NUMCB$
STRING NTRAN1$,FIELDS$,NTRAN2$,NTRAN3$,NTRAN4$,FECHA3$,NTRAN5$,NTRAN6$,NTRAN7$
STRING NTRAN8$,CREA$,CREA2$,ANO$,FEC$,AUDI1$,CEN$,CENC$,CREA3$,INICI$,BORRA$
STRING BORRA1$,BORRA2$,BORRA3$,uno$,BORRA4$, BORRA5$
INTEGER*1 A%,B%,C%,D%
INTEGER*2 NTRAN%,NTRAN1%,NTRAN10%,ANO%,CENCO%
!----------------------------------------------------------------------------

FINR$=CHR$(13)+CHR$(10)		!CREA UN FIN DE REGISTRO
CLEARS				!LIMPIA PANTALLA

A%=1 


!*********** para extraer el numero del almacen **********

OPEN "c:/adxalma.dat" DIRECT RECL 80 AS 15

!IF END #15 THEN DONE2:  
DIM ALMAS$(100)
FOR K%=1 TO 100
	 READ FORM "C80";#15,K%;AL$
	 ALMAS$(K%)=AL$
NEXT K%

AL$=ALMAS$(1)
CENC$=STR$(VAL(LEFT$(AL$,4)))

!********************************************* 




!--------------------	 MENU CAPTURA DATOS TIQUETE	 ----------------

WHILE  A%<>0
CLEARS 
PRINT "		 "
PRINT "	                    SOPORTE POS				  "
print "                   PROGRAMA PARA GENERAR TIQUETES  		  "
PRINT "                       Tec. Tulio A. Giraldo          		  "
PRINT "                                                      		  "
PRINT "                                                      		  "  
INPUT "	 DIGITE ANO - 2 DIGITOS (AA ej: 01,07,12): 	 ";ANO$ 
INPUT "	 DIGITE MES - 2 DIGITOS (MM ej: 02,09,11): 	 ";MES$ 
INPUT "	 DIGITE DIA - 2 DIGITOS (DD ej: 07,16,27):	 ";DIA$
INPUT "	 DIGITE NUM. TERMINAL - 2 DIGITOS (TT):		 ";NTER1$
INPUT "	 DIGITE NUM TRANSACCION - 4 DIGITOS (tttt):	 ";NTRAN1$  

!------ VALIDA INFORMACION INGRESADA --------------- 


IF VAL(ANO$)<0 OR VAL(ANO$)>99 THEN BEGIN
	 CLEARS
	 PRINT "		 LOS ANOS VAN DESDE 00 A 99" 
	 WAIT;2000 
ENDIF

IF VAL(MES$)>13 THEN BEGIN
	 CLEARS
	 PRINT "		 LOS MESES VAN DESDE 01 A 12"  
	 WAIT;2000 
ENDIF  
IF VAL(DIA$)<1 OR VAL(DIA$)>31 THEN BEGIN
	 CLEARS
	 PRINT "		 LOS DIAS VAN DESDE 01 A 31" 
	 WAIT;2000 
ENDIF

IF VAL(NTER1$)<1 AND VAL(NTER$)>99 THEN BEGIN
	 CLEARS
	 PRINT "		 LAS TERMINALES SOLO LLEGAN HASTA 99"
	 WAIT;2000
ENDIF 
IF VAL(NTRAN1$)>9999 THEN BEGIN
	 CLEARS
	 PRINT "		 LAS TRANSACCIONES LLEGAN HASTA 9999"
	 WAIT;2000
ENDIF

ANO%=VAL(ANO$)
MES%=VAL(MES$)					 !CONVIERTE STRING EN VALOR
DIA%=VAL(DIA$)



IF ANO%>=0 AND ANO%<=99 AND MES%>0 AND MES%<13 AND DIA%>0 AND DIA%<32 THEN BEGIN 
	 FECHA1$=RIGHT$("0"+MES$,1)		 !ENCAPSULA EL STRING EN UN CARACTER
	 IF MES$="10" THEN BEGIN
		 FECHA1$="A"
	 ENDIF 
	 IF MES$="11" THEN BEGIN
		 FECHA1$="B"
	 ENDIF 
	 IF MES$="12" THEN BEGIN
		 FECHA1$="C"
	 ENDIF  
	 FEC$=RIGHT$("00"+ANO$,2)
	 AUD1$=RIGHT$("00"+MES$,2)
	 FECHA2$=RIGHT$("00"+DIA$,2)
	 NTER$=RIGHT$("00"+NTER1$,2)
	 FECHA3$=RIGHT$("000"+NTER1$,3)		 !ENCAPSULA EL STRING EN 3 CARACTERES
	 FECHA$="C:/EJ/J/J"+FECHA1$+FECHA2$+FECHA3$
!	 ARCHI$=FECHA$+".TXT"
	 AUD$="C:/ADX_UDT1/AUD"+AUD1$+FECHA2$+".DAT"
	 AUDI1$="C:/ADX_UDT1/JE"+FEC$+AUD1$+FECHA2$+"."+CENC$
	 A%=0 
ENDIF 
WEND      


ON ERROR GOTO ERRORTRAP

OPEN FECHA$ AS 19



ERRORTRAP:
ERRORCOD$=ERR  
IF ERRORCOD$="OE" THEN BEGIN
	 CLEARS
	 PRINT "				 " 
	 PRINT "				 "
	 PRINT "				 "
	 PRINT "				 "
	 PRINT "				 "
	 PRINT "				 " 
	 PRINT "			LO SIENTO !! 		" 
	 PRINT "				 "
	 PRINT " NO SE ENCONTRO EL ARCHIVO PARA IMPRIMIR EL TIQUETE "
	 PRINT "				 "
	 PRINT "	DIGITE LA OPCION 2 PARA INTENTARLO NUEVAMENTE " 
	 CREA$="ADXNSXZL S "+AUD$+" C:/EJ/J/"
	 CREA3$="ADXNSXZL S "+AUDI1$+" C:/EJ/J/"
	 CREA2$="QXLUPACK "+FECHA$+".C C:/EJ/J/J"+FECHA1$+FECHA2$+FECHA3$
	 CREATE "C:/COMFANDI/DESCO.BAT" AS 5
	 WRITE FORM "C70 C2";#5;"ECHO OF",FINR$ 
	 WRITE FORM "C70 C2";#5;"IF EXIST "+FECHA$+" GOTO CREA",FINR$  
	 WRITE FORM "C70 C2";#5;"IF EXIST "+FECHA$+".c GOTO CREA2",FINR$  
	 WRITE FORM "C70 C2";#5;"IF NOT EXIST "+FECHA$+" GOTO CREA1",FINR$
	 WRITE FORM "C70 C2";#5;" ",FINR$ 
!	 WRITE FORM "C70 C2";#5;"ADX_UPGM:TIQUE.286",FINR$
	 WRITE FORM "C70 C2";#5;":CREA",FINR$
	 WRITE FORM "C70 C2";#5;"COPY "+FECHA$+" "+"C:/DATOS/",FINR$
	 WRITE FORM "C70 C2";#5;"ADX_UPGM:TIQUE1.286" ,FINR$  
	 WRITE FORM "C70 C2";#5;"print c:/datos/file.txt" ,FINR$  
	 WRITE FORM "C70 C2";#5;"EXIT",FINR$ 
	 WRITE FORM "C70 C2";#5;" ",FINR$    
	 WRITE FORM "C70 C2";#5;":CREA1",FINR$ 
	 WRITE FORM "C70 C2";#5;CREA$,FINR$   
	 WRITE FORM "C70 C2";#5;CREA3$,FINR$  
	 WRITE FORM "C70 C2";#5;"ADX_UPGM:TIQUE.286" ,FINR$  
	 WRITE FORM "C70 C2";#5;"EXIT",FINR$ 
	 WRITE FORM "C70 C2";#5;" ",FINR$    
	 WRITE FORM "C70 C2";#5;":CREA2",FINR$ 
	 WRITE FORM "C70 C2";#5;CREA2$,FINR$  
	 WRITE FORM "C70 C2";#5;"ADX_UPGM:TIQUE.286",FINR$ 
	 WRITE FORM "C70 C2";#5;"EXIT",FINR$ 
	 WAIT; 10000
	 STOP
ENDIF


CREATE "C:/DATOS/FILE.TXT" AS 10 
OPEN "C:/DATOS/FILE.TXT" AS 11 APPEND

B%=1 
IF B%=1 THEN BEGIN 
NTRAN%=VAL(NTRAN1$)-1
NTRAN10%=VAL(NTRAN1$)
NTRAN7$=STR$(NTRAN10%)
NTRAN8$=RIGHT$("0000" + NTRAN7$,4)
NTRAN2$=STR$(NTRAN%)				 !CONVIERTE VALOR EN STRING
NTRAN$=RIGHT$("0000" + NTRAN2$,4)   		 !ENCAPSULA STRING EN 4 CARACTERES
NTRAN6$="111111"

K%=0
IF VAL(NTRAN1$)=1 THEN BEGIN
	 K%=1
	 NTRAN%=VAL(NTRAN1$)
	 NTRAN2$=STR$(NTRAN%)
	 NTRAN$=RIGHT$("0000" + NTRAN2$,4)   
	 NTRAN6$="111111" 
ENDIF 

H%=0
IF END #19 THEN DONE1: 
WHILE 19 
	 READ #19;FIELDS$
	 TIQUE$ = MID$(FIELDS$,21,7)  
	 NTRAN5$ = NTER$+" "+NTRAN8$
	 IF TIQUE$=NTRAN5$ THEN BEGIN
		 H%=H%+1
	 ENDIF
WEND 

DONE1:
CLOSE 19


OPEN FECHA$ AS 19

BORRA$="C O M F A N D I"
BORRA1$="NIT 890303208-5"
BORRA2$="COMFANDI"
BORRA3$="NIT 890.303.208-5"
uno$=".       " 
BORRA4$="INFORMACION DE PUNTAJE"
BORRA5$="*----INFORMACION DE PUNTAJE---*"


WRITE FORM "C50 C2";#11;"    C O M F A N D I ",FINR$  
WRITE FORM "C50 C2";#11;"         NIT 890303208-5",FINR$  


A%=0
	 WHILE (B%<>0)  
		 IF K%=1 THEN BEGIN 
			 READ #19;FIELDS$
	                 TIQUE$ = MID$(FIELDS$,21,7)	 !TOMA 7 CARACTERES A PARTIR DEL CARACTER 21 EN UN STRING
			 NTRAN5$=NTER$+" "+NTRAN$ 
			 IF (MATCH(BORRA$,FIELDS$,1)>0 OR MATCH(BORRA1$,FIELDS$,1)>0 OR MATCH(BORRA2$,FIELDS$,1)>0 OR MATCH(BORRA3$,FIELDS$,1)>0 OR MATCH(BORRA4$,FIELDS$,1)>0) THEN BEGIN
			    IF MATCH(BORRA$,FIELDS$,1)>0 THEN BEGIN    !compara 2 variables inciando desde el caracter 1
				xx%=1
!				WRITE FORM "C50 C2";#11;uno$+BORRA$,FINR$
			    ENDIF
			    IF MATCH(BORRA1$,FIELDS$,1)>0 THEN BEGIN    !compara 2 variables inciando desde el caracter 1
				xx%=1
!				WRITE FORM "C50 C2";#11;uno$+BORRA1$,FINR$
			    ENDIF
			    IF MATCH(BORRA2$,FIELDS$,1)>0 THEN BEGIN 
				xx%=1
!			 	WRITE FORM "C50 C2";#11;uno$+BORRA2$,FINR$   
			    ENDIF 
			    IF MATCH(BORRA3$,FIELDS$,1)>0 THEN BEGIN 
				xx%=1
!			 	WRITE FORM "C50 C2";#11;uno$+BORRA3$,FINR$   
			    ENDIF 
			    IF MATCH(BORRA4$,FIELDS$,1)>0 THEN BEGIN 
				xx%=1
			 	WRITE FORM "C50 C2";#11;BORRA5$,FINR$   
			    ENDIF
			 ENDIF ELSE BEGIN
			    WRITE FORM "C50 C2";#11;FIELDS$,FINR$ 
			 endif
			 IF TIQUE$=NTRAN5$ THEN BEGIN   
				 H%=H%-1
				 IF H%=0 THEN BEGIN 
					 K%=0
					 B%=0
				 ENDIF
			 ENDIF 
		 ENDIF ELSE BEGIN
			 READ #19;FIELDS$
                	 TIQUE$ = MID$(FIELDS$,21,7) 
			 NTRAN5$=NTER$+" "+NTRAN$ 
			 IF TIQUE$=NTRAN5$ THEN BEGIN 
			    C%=1
			    NTRAN%=NTRAN%+1 
			    NTRAN3$=STR$(NTRAN%) 
			    NTRAN4$=RIGHT$("0000" + NTRAN3$,4) 
			    NTRAN6$=NTER$+" "+NTRAN4$
			 ENDIF 
			 IF C%=1 THEN BEGIN  
				 A%=A%+1
				 IF A%>1 THEN BEGIN
			 	 IF (MATCH(BORRA$,FIELDS$,1)>0 OR MATCH(BORRA1$,FIELDS$,1)>0 OR MATCH(BORRA2$,FIELDS$,1)>0 OR MATCH(BORRA4$,FIELDS$,1)>0) THEN BEGIN
			    		 IF MATCH(BORRA$,FIELDS$,1)>0 THEN BEGIN
						xx%=1
!					    	WRITE FORM "C50 C2";#11;uno$+BORRA$,FINR$
					  ENDIF
			    		 IF MATCH(BORRA1$,FIELDS$,1)>0 THEN BEGIN
						xx%=1
!					    	WRITE FORM "C50 C2";#11;uno$+BORRA1$,FINR$
					  ENDIF
			    		  IF MATCH(BORRA2$,FIELDS$,1)>0 THEN BEGIN
						xx%=1
!					    	WRITE FORM "C50 C2";#11;uno$+BORRA2$,FINR$   
					  ENDIF 
			    		  IF MATCH(BORRA4$,FIELDS$,1)>0 THEN BEGIN
						xx%=1
					    	WRITE FORM "C50 C2";#11;BORRA4$,FINR$   
					  ENDIF
				    ENDIF ELSE BEGIN
					WRITE FORM "C50 C2";#11;FIELDS$,FINR$  
				    ENDIF
				 ENDIF
			 ENDIF
			 IF TIQUE$=NTRAN6$ THEN BEGIN  
				 H%=H%-1
				 IF H%=0 THEN BEGIN 
					 C%=0
					 B%=0
				 ENDIF
			 ENDIF 
		 ENDIF
		 IF END #19 THEN DONE:
	 WEND    
ENDIF


DONE2:
CLOSE 15

DONE: 
B%=0  


END



 
